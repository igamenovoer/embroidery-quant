<div class="processor-container">
  <!-- Controls Panel -->
  <mat-card class="controls-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>tune</mat-icon>
        Processing Controls
      </mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <div class="controls-grid">
        <!-- Bilateral Filter Controls -->
        <div class="control-section">
          <h3 class="section-title">
            <mat-icon>filter_alt</mat-icon>
            Bilateral Filter
          </h3>
          
          <div class="slider-group">
            <div class="slider-control">
              <label class="slider-label">Spatial Sigma: {{bilateralParams.sigmaSpace}}</label>
              <input 
                type="range"
                min="1" 
                max="50" 
                step="1"
                class="control-slider"
                [(ngModel)]="bilateralParams.sigmaSpace"
                (input)="onSliderChange()"
                (change)="onSliderChange()">
            </div>

            <div class="slider-control">
              <label class="slider-label">Color Sigma: {{bilateralParams.sigmaColor}}</label>
              <input 
                type="range"
                min="1" 
                max="100" 
                step="1"
                class="control-slider"
                [(ngModel)]="bilateralParams.sigmaColor"
                (input)="onSliderChange()"
                (change)="onSliderChange()">
            </div>

            <div class="slider-control">
              <label class="slider-label">Kernel Size: {{bilateralParams.kernelSize}}</label>
              <input 
                type="range"
                min="3" 
                max="15" 
                step="2"
                class="control-slider"
                [(ngModel)]="bilateralParams.kernelSize"
                (input)="onSliderChange()"
                (change)="onSliderChange()">
            </div>
          </div>
        </div>

        <!-- Quantization Controls -->
        <div class="control-section">
          <h3 class="section-title">
            <mat-icon>palette</mat-icon>
            Color Quantization
          </h3>

          <div class="slider-group">
            <div class="slider-control">
              <label class="slider-label">Color Count: {{quantizationConfig.colorCount}}</label>
              <input 
                type="range"
                min="2" 
                max="64" 
                step="1"
                class="control-slider"
                [(ngModel)]="quantizationConfig.colorCount"
                (input)="onSliderChange()"
                (change)="onSliderChange()">
            </div>

            <div class="select-control">
              <mat-form-field appearance="outline" class="select-field">
                <mat-label>Dithering Algorithm</mat-label>
                <mat-select 
                  [(ngModel)]="quantizationConfig.ditheringAlgorithm"
                  (selectionChange)="onSelectChange()">
                  <mat-option *ngFor="let option of ditheringOptions" [value]="option.value">
                    {{option.label}}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>

            <div class="slider-control">
              <label class="slider-label">Dithering Intensity: {{(quantizationConfig.ditheringIntensity * 100).toFixed(0)}}%</label>
              <input 
                type="range"
                min="0" 
                max="0.2" 
                step="0.01"
                class="control-slider"
                [(ngModel)]="quantizationConfig.ditheringIntensity"
                (input)="onSliderChange()"
                (change)="onSliderChange()">
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <mat-divider class="action-divider"></mat-divider>
      <div class="action-buttons">
        <button 
          mat-stroked-button 
          color="primary"
          (click)="resetToDefaults()"
          [disabled]="isProcessing">
          <mat-icon>refresh</mat-icon>
          Reset to Defaults
        </button>
        
        <div class="spacer"></div>
        
        <mat-chip-set *ngIf="palette.length > 0" class="color-info">
          <mat-chip color="accent" selected>
            <mat-icon>palette</mat-icon>
            {{palette.length}} colors
          </mat-chip>
        </mat-chip-set>
        
        <span class="processing-time" *ngIf="processingTime > 0">
          <mat-icon>schedule</mat-icon>
          {{processingTime.toFixed(0)}}ms
        </span>

        <button 
          mat-raised-button 
          color="primary"
          (click)="downloadResult()"
          [disabled]="!finalImageData || isProcessing">
          <mat-icon>download</mat-icon>
          Download Result
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Processing Status -->
  <mat-card *ngIf="isProcessing" class="processing-card">
    <mat-card-content>
      <div class="processing-status">
        <mat-spinner diameter="40"></mat-spinner>
        <span class="processing-text">{{processingStage}}</span>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Image Display Tabs -->
  <mat-card *ngIf="originalImageData && !isProcessing" class="results-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>image</mat-icon>
        Processing Results
      </mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <mat-tab-group 
        mat-stretch-tabs="false" 
        mat-align-tabs="start" 
        class="image-tabs"
        [selectedIndex]="selectedTabIndex"
        (selectedTabChange)="onTabChanged($event.index)">
        <!-- Original Image -->
        <mat-tab label="Original">
          <ng-template matTabContent>
            <div class="stage-container">
              <h3 class="stage-title">Original Image</h3>
              <img [src]="getCanvasDataUrl(originalCanvas)" alt="Original Image" class="result-image">
            </div>
          </ng-template>
        </mat-tab>

        <!-- Bilateral Filtered -->
        <mat-tab label="Filtered">
          <ng-template matTabContent>
            <div class="stage-container">
              <h3 class="stage-title">Bilateral Filtered</h3>
              <img [src]="getCanvasDataUrl(filteredCanvas)" alt="Filtered Image" class="result-image">
              <p class="stage-description text-muted">
                Edge-preserving smoothing applied
              </p>
            </div>
          </ng-template>
        </mat-tab>

        <!-- Quantized -->
        <mat-tab label="Quantized">
          <ng-template matTabContent>
            <div class="stage-container">
              <h3 class="stage-title">Color Quantized</h3>
              <img [src]="getCanvasDataUrl(quantizedCanvas)" alt="Quantized Image" class="result-image">
              <p class="stage-description text-muted">
                Reduced to {{palette.length}} unique colors
              </p>
            </div>
          </ng-template>
        </mat-tab>

        <!-- Final Result -->
        <mat-tab label="Final Result">
          <ng-template matTabContent>
            <div class="stage-container">
              <h3 class="stage-title">Final Result</h3>
              <img [src]="getCanvasDataUrl(finalCanvas)" alt="Final Result" class="result-image">
              <p class="stage-description text-muted">
                Ready for embroidery - {{palette.length}} colors with {{getDitheringLabel()}} dithering
              </p>
            </div>
          </ng-template>
        </mat-tab>
      </mat-tab-group>
    </mat-card-content>
  </mat-card>

  <!-- No Image State -->
  <mat-card *ngIf="!originalImageData && !isProcessing" class="no-image-card">
    <mat-card-content>
      <div class="no-image-state">
        <mat-icon class="no-image-icon">image_not_supported</mat-icon>
        <h3>No image selected</h3>
        <p class="text-muted">Please upload an image to begin processing</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>